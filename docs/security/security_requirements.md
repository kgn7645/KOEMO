# KOEMO セキュリティ要件書

## 1. 概要

### 1.1 目的
本文書は、KOEMOアプリケーションのセキュリティ要件を定義し、安全で信頼できるランダム音声通話サービスを提供するための技術的・運用的セキュリティ基準を明確にすることを目的とします。

### 1.2 適用範囲
- iOS クライアントアプリケーション
- Node.js バックエンドサーバー
- WebRTC 音声通話システム
- データベース（MongoDB）
- インフラストラクチャ
- 運用・監視システム

### 1.3 セキュリティの基本方針
- **プライバシーファースト**: ユーザーの匿名性とプライバシーを最優先
- **エフェメラル設計**: 不要なデータは24時間で自動削除
- **最小権限の原則**: 必要最小限のデータ収集と権限付与
- **透明性**: セキュリティ対策とプライバシー保護の方針を明確化

## 2. 脅威モデルと想定リスク

### 2.1 主要な脅威
| 脅威 | 影響度 | 発生確率 | 対策優先度 |
|------|--------|----------|------------|
| 個人情報漏洩 | 高 | 中 | 高 |
| 不適切な通話内容（迷惑行為） | 高 | 高 | 高 |
| なりすまし・偽装 | 中 | 中 | 中 |
| DDoS攻撃 | 中 | 中 | 中 |
| 通話盗聴 | 高 | 低 | 高 |
| 未成年者への不適切アプローチ | 高 | 中 | 高 |
| サーバー侵害 | 高 | 低 | 高 |

### 2.2 攻撃者モデル
- **一般的な迷惑ユーザー**: 不適切な発言や行為を行うユーザー
- **悪意のある第三者**: 個人情報取得や営利目的の攻撃者
- **技術的攻撃者**: システムの脆弱性を狙う外部攻撃者
- **内部脅威**: 運営側の内部関係者による不正アクセス

## 3. データ保護・プライバシーセキュリティ要件

### 3.1 個人情報管理
#### 3.1.1 データ最小化
- **要件**: 収集する個人情報は機能に必要最小限に制限
- **対象データ**: ニックネーム、性別、年齢、地域（オプション）のみ
- **禁止事項**: 
  - メールアドレス収集禁止
  - 電話番号収集禁止
  - 実名収集禁止
  - 写真・画像収集禁止

#### 3.1.2 データの匿名化
- **デバイスID**: UUID v4による匿名識別子使用
- **ユーザーID**: 内部生成UUIDで個人特定不可
- **通話ログ**: 個人を特定できる情報を含まない

#### 3.1.3 データ保持期間
- **通話履歴**: 24時間後自動削除（技術仕様で実装済み）
- **メッセージ**: 24時間後自動削除（TTLインデックス使用）
- **ユーザープロフィール**: アプリ削除時または90日間非アクティブで削除
- **ログデータ**: 技術的な問題解決に必要な期間のみ（最大30日）

### 3.2 データ暗号化
#### 3.2.1 保存時暗号化
- **データベース**: MongoDB Encryption at Rest有効化
- **暗号化アルゴリズム**: AES-256-GCM
- **キー管理**: AWS KMS またはHashiCorp Vault使用

#### 3.2.2 転送時暗号化
- **API通信**: TLS 1.3 必須
- **WebSocket**: WSS (WebSocket Secure) 必須
- **音声通話**: WebRTC DTLS-SRTP 暗号化

### 3.3 プライバシー設計
#### 3.3.1 段階的プロフィール開示
- **0-30秒**: ニックネームのみ表示
- **30-60秒**: 年齢追加表示
- **60-180秒**: 地域追加表示
- **180秒以上**: 全情報表示
- **通話終了後**: 相手のプロフィール情報は24時間で削除

#### 3.3.2 トレーサビリティ制限
- **IP アドレス**: ログ保存は24時間以内
- **デバイス情報**: 最小限の技術情報のみ
- **位置情報**: 収集・保存禁止

## 4. 通信セキュリティ要件

### 4.1 ネットワーク通信
#### 4.1.1 暗号化プロトコル
- **HTTP**: HTTPS (TLS 1.3) 必須
- **WebSocket**: WSS 必須
- **最小TLSバージョン**: TLS 1.2（推奨: TLS 1.3）
- **暗号スイート**: AEAD暗号スイートのみ許可

#### 4.1.2 証明書管理
- **SSL/TLS証明書**: Extended Validation (EV) または Organization Validation (OV)
- **証明書透明性**: Certificate Transparency対応
- **HSTS**: HTTP Strict Transport Security有効化
- **証明書ピニング**: iOS アプリでのCertificate Pinning実装

### 4.2 WebRTC セキュリティ
#### 4.2.1 P2P通話暗号化
- **DTLS**: Datagram Transport Layer Security必須
- **SRTP**: Secure Real-time Transport Protocol必須
- **ICE**: Interactive Connectivity Establishment with STUN/TURN
- **キー交換**: ECDHE (楕円曲線ディフィー・ヘルマン鍵交換)

#### 4.2.2 シグナリングセキュリティ
- **認証**: JWT ベースの認証必須
- **権限確認**: 通話参加者の事前認証
- **シグナリングサーバー**: 中継のみで音声データにアクセス不可

### 4.3 API セキュリティ
#### 4.3.1 認証・認可
- **認証方式**: JWT Bearer Token
- **トークン有効期限**: アクセストークン 1時間、リフレッシュトークン 30日
- **スコープベース認可**: 最小権限の原則適用
- **レート制限**: エンドポイント別のレート制限実装

#### 4.3.2 入力検証
- **パラメータ検証**: 全入力データの型・範囲・形式検証
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **XSS対策**: 入力サニタイゼーション実装
- **CSRF対策**: SameSite Cookie属性使用

## 5. アプリケーションセキュリティ要件

### 5.1 iOS アプリセキュリティ
#### 5.1.1 データ保護
- **Keychain**: 認証トークンのKeychain保存
- **App Transport Security**: ATS有効化
- **Data Protection API**: ファイル暗号化有効化
- **Background App Refresh**: 通話中のみ有効化

#### 5.1.2 実行時保護
- **コード署名**: App Store配布のみ
- **Jailbreak検知**: 改竄された端末での実行制限
- **デバッグ防止**: リリース版でのデバッグ機能無効化
- **SSL Pinning**: 証明書ピニング実装

#### 5.1.3 権限管理
- **マイク権限**: 通話時のみ要求
- **ネットワーク権限**: 明示的な許可
- **プッシュ通知**: VoIP通知のみ使用
- **バックグラウンド実行**: 通話継続に必要な最小限

### 5.2 バックエンドセキュリティ
#### 5.2.1 サーバー要塞化
- **OS設定**: 不要サービス無効化
- **ファイアウォール**: 必要ポートのみ開放
- **パッチ管理**: 定期的なセキュリティ更新
- **ログ管理**: 包括的なアクセスログ記録

#### 5.2.2 依存関係管理
- **脆弱性スキャン**: npm audit, Snyk等での定期チェック
- **パッケージ署名**: 信頼できるレジストリからのみ取得
- **ライセンス管理**: オープンソースライセンス遵守

#### 5.2.3 設定管理
- **環境変数**: 機密情報の環境変数管理
- **シークレット管理**: AWS Secrets Manager または HashiCorp Vault
- **設定分離**: 開発・ステージング・本番環境の分離

## 6. ユーザー安全・違反対策要件

### 6.1 コンテンツモデレーション
#### 6.1.1 24時間監視体制
- **監視体制**: 24時間365日のモニタリング
- **対応時間**: 重大な違反報告への1時間以内対応
- **エスカレーション**: 緊急時の迅速な対応体制

#### 6.1.2 自動検知システム
- **NGワード検出**: チャットメッセージの自動フィルタリング
- **異常行動検知**: 短時間での大量通話など異常パターンの検知
- **スパム対策**: 同一内容の連続送信防止

### 6.2 通報・制裁システム
#### 6.2.1 通報機能
- **通報ボタン**: 通話中・チャット中の即座通報
- **自動スクリーンショット**: 通報時の証拠自動送信
- **通報理由**: 詳細な違反カテゴリ選択
- **匿名通報**: 通報者の匿名性保護

#### 6.2.2 制裁措置
- **警告システム**: 軽微な違反への警告
- **一時停止**: 重大な違反への利用停止（1日、3日、7日）
- **永久BAN**: 極めて重大な違反への永久利用停止
- **デバイスBAN**: 端末レベルでの利用制限

### 6.3 未成年者保護
#### 6.3.1 年齢制限
- **App Store設定**: 17歳以上の年齢制限
- **利用規約**: 18歳未満の利用禁止明記
- **年齢確認**: 自己申告ベースの年齢入力

#### 6.3.2 不適切接触防止
- **フィルタリング**: 不適切なキーワードの自動検知
- **教育的配慮**: 安全な利用方法の啓発
- **保護者通知**: 必要に応じた保護者への連絡体制

## 7. インフラ・運用セキュリティ要件

### 7.1 クラウドセキュリティ
#### 7.1.1 ネットワークセキュリティ
- **VPC**: 専用仮想プライベートクラウド
- **セキュリティグループ**: 最小権限のファイアウォール設定
- **WAF**: Web Application Firewall導入
- **DDoS対策**: CloudFlare または AWS Shield導入

#### 7.1.2 アクセス制御
- **IAM**: Identity and Access Management
- **多要素認証**: MFA必須
- **最小権限**: 業務に必要最小限のアクセス権限
- **アクセス監査**: 定期的な権限見直し

### 7.2 監視・ログ管理
#### 7.2.1 セキュリティ監視
- **SIEM**: Security Information and Event Management
- **異常検知**: 機械学習ベースの異常行動検知
- **侵入検知**: IDS/IPS システム導入
- **脆弱性スキャン**: 定期的な脆弱性診断

#### 7.2.2 ログ管理
- **ログ収集**: 包括的なアプリケーション・システムログ
- **ログ保存**: 改ざん防止機能付きログストレージ
- **ログ分析**: リアルタイムログ分析とアラート
- **ログ保持**: セキュリティ要件に応じた保持期間設定

### 7.3 バックアップ・災害復旧
#### 7.3.1 データバックアップ
- **自動バックアップ**: 日次の自動バックアップ
- **暗号化バックアップ**: バックアップデータの暗号化
- **オフサイト保存**: 地理的に分散したバックアップ
- **復旧テスト**: 定期的な復旧手順テスト

#### 7.3.2 事業継続性
- **災害復旧計画**: BCP/DRP策定
- **復旧時間目標**: RTO 4時間以内
- **復旧ポイント目標**: RPO 1時間以内
- **代替サイト**: マルチリージョン構成

## 8. コンプライアンス要件

### 8.1 法的要件
#### 8.1.1 日本の法令遵守
- **個人情報保護法**: 個人情報の適切な取扱い
- **電気通信事業法**: 通信の秘密保護
- **青少年インターネット環境整備法**: 有害情報フィルタリング
- **特定電子メール法**: 迷惑メール防止

#### 8.1.2 業界ガイドライン
- **総務省ガイドライン**: 利用者情報の取扱い
- **個人情報保護委員会ガイドライン**: 個人情報保護
- **App Store Review Guidelines**: Apple社ガイドライン遵守

### 8.2 セキュリティ標準
#### 8.2.1 国際標準
- **ISO 27001**: 情報セキュリティマネジメントシステム
- **NIST Cybersecurity Framework**: サイバーセキュリティフレームワーク
- **OWASP Top 10**: Webアプリケーションセキュリティ

## 9. セキュリティ運用要件

### 9.1 インシデント対応
#### 9.1.1 対応体制
- **CSIRT**: Computer Security Incident Response Team設置
- **エスカレーション**: 重要度別の対応手順
- **外部連携**: 警察・JPCERT/CC等との連携体制
- **ユーザー通知**: 必要に応じた影響ユーザーへの通知

#### 9.1.2 対応手順
- **検知**: 24時間監視による早期検知
- **初動対応**: 1時間以内の初動対応
- **影響評価**: 被害範囲・影響度の迅速な評価
- **復旧対応**: 迅速なサービス復旧
- **事後対応**: 再発防止策の策定・実施

### 9.2 セキュリティ教育
#### 9.2.1 開発チーム教育
- **セキュアコーディング**: 安全な開発手法の教育
- **脆弱性対策**: 最新の脅威・対策情報の共有
- **定期研修**: 四半期ごとのセキュリティ研修

#### 9.2.2 運用チーム教育
- **インシデント対応**: 対応手順の定期的な訓練
- **ログ分析**: ログ解析スキルの向上
- **最新動向**: セキュリティ脅威の最新情報共有

### 9.3 セキュリティ評価
#### 9.3.1 定期評価
- **ペネトレーションテスト**: 年2回の侵入テスト
- **脆弱性診断**: 四半期ごとの脆弱性スキャン
- **セキュリティ監査**: 年1回の外部監査
- **リスク評価**: 半年ごとのリスクアセスメント

#### 9.3.2 継続的改善
- **セキュリティメトリクス**: KPIによる効果測定
- **改善計画**: 評価結果に基づく改善計画策定
- **投資計画**: セキュリティ投資の優先順位付け

## 10. 付録

### 10.1 用語集
- **エフェメラル**: 一時的で自動削除される特性
- **WebRTC**: Web Real-Time Communication
- **P2P**: Peer-to-Peer通信
- **DTLS-SRTP**: WebRTCの暗号化プロトコル
- **JWT**: JSON Web Token
- **TTL**: Time To Live（生存時間）

### 10.2 参考文献
- NIST Cybersecurity Framework
- OWASP Application Security Verification Standard
- ISO/IEC 27001:2013
- 個人情報保護法ガイドライン（個人情報保護委員会）
- 電気通信事業における個人情報保護に関するガイドライン（総務省）

### 10.3 文書管理
- **作成日**: 2024年1月
- **版数**: 1.0
- **承認者**: セキュリティ責任者
- **次回見直し**: 2024年7月（半年後）
- **更新履歴**: 新規作成

---

本文書は機密情報を含むため、適切な取扱いが必要です。