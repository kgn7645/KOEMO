# KOEMO iOS アプリテストガイド

## 🎯 iOS同士での音声通話テスト方法

### 1. バックエンドサーバー起動

```bash
cd /Users/sou/Documents/AI_Driven_Dev/KOEMO/backend
./start_koemo_server.sh
```

サーバーが起動したら、コンソールに表示される**ローカルIPアドレス**をメモしてください。
例: `192.168.0.8`

### 2. iOS アプリの設定

`ios/KOEMO/Services/WebSocketService.swift` の42行目を編集：

```swift
// 変更前
guard let url = URL(string: "ws://192.168.0.8:3000?token=\(token)") else {

// 変更後（実際のIPアドレスに置き換え）  
guard let url = URL(string: "ws://[YOUR_IP]:3000?token=\(token)") else {
```

### 3. テスト手順

#### パターン1: 2台の実機でテスト
1. 2台のiPhone/iPadを用意
2. 両方の端末で同じWiFiネットワークに接続
3. XcodeでKOEMOアプリを両方にビルド&インストール
4. 両方のアプリを起動し、通話ボタンをタップ
5. マッチングが成功すると通話画面に遷移
6. 音声通話が開始される

#### パターン2: 実機 + シミュレーターでテスト
1. iPhoneなどの実機とXcodeシミュレーターを使用
2. 実機では通常のビルド、シミュレーターではデバッグビルドを実行
3. 両方で通話ボタンをタップしてテスト

#### パターン3: 2台のシミュレーターでテスト
1. Xcodeで2つの異なるシミュレーターを起動（例：iPhone 15とiPhone 14）
2. 両方でアプリを実行
3. 通話ボタンをタップしてマッチング開始

### 4. 期待される動作

1. **接続確認**
   - アプリ起動時にWebSocket接続成功ログが表示される
   - コンソールに「✅ WebSocket connected」が出力される

2. **マッチング**
   - 通話ボタンをタップするとマッチング画面が表示される
   - バックエンドで他のユーザーが見つかるとマッチ成功

3. **通話開始**
   - マッチ成功後、自動的に通話画面に遷移
   - マイクの権限を許可すると音声通話が開始される
   - 音声レベルインジケータが動作する

4. **通話機能**
   - ミュートボタンで音声ON/OFF
   - スピーカーボタンで音声出力切り替え
   - 終了ボタンで通話終了

### 5. トラブルシューティング

#### 接続エラーの場合
```
❌ WebSocket connection failed
```
- IPアドレスが正しいか確認
- バックエンドサーバーが起動しているか確認
- WiFiネットワークが同じか確認

#### マッチングしない場合  
```
⏰ Matching timeout
```
- 2台目のアプリが起動しているか確認
- 両方で通話ボタンを押したか確認
- バックエンドログでマッチング処理を確認

#### 音声が聞こえない場合
```
❌ Audio session configuration failed
```
- マイクの権限が許可されているか確認
- イヤホンやスピーカーの設定を確認
- 音量設定を確認

### 6. デバッグログの見方

#### iOS アプリログ
- `📞` WebRTC関連のログ
- `🔌` WebSocket接続のログ  
- `🎉` マッチング成功のログ
- `🎵` 音声ストリーム受信のログ

#### バックエンドログ
- `🔌 WebSocket connected: [user_id]` - ユーザー接続
- `🎯 User [user_id] wants to start matching` - マッチング開始
- `✅ Match created: [user1] <-> [user2]` - マッチ成功
- `📞 Call ID: [call_id]` - 通話ID生成
- `🏠 Room ID: [room_id]` - WebRTCルーム作成

### 7. 成功時の完全なフロー

1. ユーザー1: アプリ起動 → WebSocket接続成功
2. ユーザー2: アプリ起動 → WebSocket接続成功  
3. ユーザー1: 通話ボタンタップ → マッチング開始
4. ユーザー2: 通話ボタンタップ → マッチング成功
5. 両ユーザー: `match-found`メッセージ受信
6. 両ユーザー: `start-call`メッセージ受信
7. 両ユーザー: 通話画面表示、WebRTC接続開始
8. ユーザー1（initiator）: Offer作成・送信
9. ユーザー2: Offer受信、Answer作成・送信
10. 両ユーザー: ICE candidate交換
11. 両ユーザー: 音声通話開始

この手順で、iOS同士での音声通話が正常に動作するはずです。